<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 è·¨å¹´éŠ | è¡Œç¨‹ + çµ±è¨ˆ + AI æƒé›· (å››åˆä¸€)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@500&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* 1. åŸºç¤è¨­å®šï¼šæ·±è‰²è–èª•å¤œèƒŒæ™¯ (ä¾†è‡ª A) */
        html, body {
            margin: 0; padding: 0; width: 100%; min-height: 100vh;
            background-color: #0f172a; color: #E2E8F0; 
            font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden;
            /* è–èª•è‰²å…‰æšˆ */
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(220, 38, 38, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.15) 0%, transparent 40%);
        }

        /* 2. é›ªèŠ±/ç…™ç«ç‰¹æ•ˆå®¹å™¨ (ä¾†è‡ª A) */
        #snow-container, #fireworks-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; 
        }
        .snowflake { position: absolute; top: -10px; color: #fff; font-size: 1.2rem; opacity: 0.8; animation: snowfall linear infinite; text-shadow: 0 0 5px rgba(255,255,255,0.8); }
        @keyframes snowfall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0.2; } }
        
        /* ç…™ç« (ä¾†è‡ª A) - ä¿æŒåŸæœ¬çš„ç…™ç«å‹•ç•« */
        @keyframes firework { 0% { transform: translate(var(--x), var(--initialY)); width: var(--initialSize); opacity: 1; } 50% { width: 0.5vmin; opacity: 1; } 100% { width: var(--finalSize); opacity: 0; } }
        .firework, .firework::before, .firework::after { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 0.5vmin; aspect-ratio: 1; background: radial-gradient(circle, #ff0 0.2vmin, #0000 0) 50% 00%, radial-gradient(circle, #ff0 0.3vmin, #0000 0) 00% 50%, radial-gradient(circle, #ff0 0.5vmin, #0000 0) 50% 99%, radial-gradient(circle, #ff0 0.2vmin, #0000 0) 99% 50%, radial-gradient(circle, #ff0 0.3vmin, #0000 0) 80% 90%, radial-gradient(circle, #ff0 0.5vmin, #0000 0) 95% 90%, radial-gradient(circle, #ff0 0.5vmin, #0000 0) 10% 60%, radial-gradient(circle, #ff0 0.2vmin, #0000 0) 31% 80%, radial-gradient(circle, #ff0 0.3vmin, #0000 0) 80% 10%, radial-gradient(circle, #ff0 0.2vmin, #0000 0) 90% 23%, radial-gradient(circle, #ff0 0.3vmin, #0000 0) 45% 20%, radial-gradient(circle, #ff0 0.5vmin, #0000 0) 13% 24%; background-size: 0.5vmin 0.5vmin; background-repeat: no-repeat; animation: firework 2s infinite; }
        .firework::before { content: ""; display: block; transform: translate(-50%, -50%) rotate(25deg) !important; }
        .firework::after { content: ""; display: block; transform: translate(-50%, -50%) rotate(-37deg) !important; }

        /* 3. å…§å®¹å±¤ */
        #root { position: relative; z-index: 10; }
        
        /* 4. ç»ç’ƒæ“¬æ…‹ (ä¾†è‡ª A) */
        .glass-panel {
            background: rgba(30, 41, 59, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        /* 5. AI æƒé›·å°ˆå±¬æ¨£å¼ (ä¾†è‡ª B) */
        .strategy-box {
            border-left: 3px solid #ffd700;
            background: rgba(255, 215, 0, 0.05);
        }
        
        /* 6. å…¶ä»–å…±ç”¨æ¨£å¼ */
        .leaflet-layer, .leaflet-control-zoom-in, .leaflet-control-zoom-out, .leaflet-control-attribution { filter: invert(100%) hue-rotate(180deg) brightness(90%) contrast(90%); }
        .typing-indicator span { animation: blink 1.4s infinite both; } .typing-indicator span:nth-child(2) { animation-delay: 0.2s; } .typing-indicator span:nth-child(3) { animation-delay: 0.4s; } @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .neon-text { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #FFD700, 0 0 30px #FFD700; }
        .markdown-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; } .markdown-content ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.5em; } .markdown-content p { margin-bottom: 0.5em; } .markdown-content strong { color: #FFCB77; } .markdown-content a { color: #4ECDC4; text-decoration: underline; }
    </style>
</head>
<body>
    <div id="snow-container"><div class="snowflake" style="left:10%;animation-duration:10s;">â„ï¸</div><div class="snowflake" style="left:20%;animation-duration:12s;font-size:0.8rem;">â…</div><div class="snowflake" style="left:50%;animation-duration:13s;font-size:1.5rem;">â„ï¸</div><div class="snowflake" style="left:70%;animation-duration:11s;">â…</div></div>
    <div id="fireworks-container"><div class="firework" style="left:15%;top:20%;--x:-50%;--initialY:60vmin;--initialSize:0.5vmin;--finalSize:45vmin;animation-delay:0.5s;"></div><div class="firework" style="left:85%;top:15%;--x:50%;--initialY:60vmin;--initialSize:0.5vmin;--finalSize:40vmin;animation-delay:1.2s;"></div></div>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Gemini API Helper (Merged from A and B) ---
        const generateGeminiContent = async (prompt, imageBase64 = null, useSearch = false) => {
            const defaultKey = ""; 
            let storedKey = localStorage.getItem('gemini_api_key');
            let apiKey = storedKey ? storedKey.trim() : defaultKey.trim();
            
            if (!apiKey) throw new Error("NO_API_KEY");

            const model = 'gemini-2.5-flash-preview-09-2025';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const parts = [{ text: prompt }];
            if (imageBase64) {
                const base64Data = imageBase64.split(',')[1] || imageBase64;
                parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Data } });
            }

            const payload = { contents: [{ parts: parts }] };
            
            // ä½¿ç”¨ Google Search Tool (è‹¥éœ€è¦)
            if (useSearch) {
                payload.tools = [{ "google_search": {} }];
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    if (response.status === 400 && (errData.error?.message?.includes('tool') || errData.error?.message?.includes('google_search')) && !imageBase64) {
                         const fallbackResponse = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const fallbackData = await fallbackResponse.json();
                        return fallbackData.candidates?.[0]?.content?.parts?.[0]?.text || "AI å›æ‡‰ç‚ºç©º";
                    }
                    if (response.status === 400 || response.status === 403) {
                        localStorage.removeItem('gemini_api_key'); 
                        throw new Error("API Key ç„¡æ•ˆæˆ–éæœŸï¼Œè«‹é‡æ–°è¨­å®šã€‚");
                    }
                    throw new Error(errData.error?.message || `HTTP Error: ${response.status}`);
                }
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼ŒAI æš«æ™‚ç„¡æ³•å›æ‡‰ã€‚";
            } catch (error) {
                throw error;
            }
        };

        // --- Helper functions for time calculation ---
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); var d = R * c;
            return d.toFixed(1);
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }
        const timeToMinutes = (timeStr) => { if (!timeStr) return 0; const [hours, minutes] = timeStr.split(':').map(Number); return hours * 60 + minutes; };
        const minutesToTimeStr = (minutes) => { let h = Math.floor(minutes / 60); let m = Math.floor(minutes % 60); h = h % 24; return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`; };
        const parseStayDuration = (stayStr) => { if (!stayStr || stayStr === '-') return 0; if (stayStr === 'Overnight') return 0; if (stayStr.includes('hr')) { return parseFloat(stayStr) * 60; } if (stayStr.includes('min')) { return parseInt(stayStr); } return 0; };
        const ReactMarkdown = ({ children }) => <div dangerouslySetInnerHTML={{ __html: marked.parse(children) }} />;


        // --- ICONS & CONSTANTS (Merged from A and B) ---
        const Icons = {
            Plane: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 12h5"/><path d="M13 12h3"/><path d="M19.74 7.33a2.3 2.3 0 0 1 2.93 2.93l-3.33 3.33a2.3 2.3 0 0 1-3.25 0l-7.34-7.34a2.3 2.3 0 0 1 0-3.25l3.33-3.33z"/><path d="M14.66 14.66 9 22H2l2.5-9"/><path d="M7 17l-5 5"/></svg>,
            Smile: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>,
            List: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            LayoutGrid: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            Calculator: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Clock: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Wallet: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,
            MapPin: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Ticket: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>,
            ExternalLink: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>,
            Footprints: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-.38 2-1.28 2.55-.4.25-.72.82-.72 1.25V16a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 2 13 3.8 13 8c0 1.25.38 2 1.28 2.55.4.25.72.82.72 1.25V16a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2z"/></svg>,
            Car: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H7.7c-.7 0-1.3.3-1.8.7-.9.9-2.2 2.3-2.2 2.3S1 10.6 1 11.1c-.8.2-1.5 1-1.5 1.9v3c0 .6.4 1 1 1h2"/><path d="M2.5 17a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/><path d="M16.5 17a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/><path d="M12 9V6"/></svg>,
            Navigation: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            Hotel: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2Z"/><polyline points="7 2 7 20"/><polyline points="17 2 17 20"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="2" x2="22" y1="17" y2="17"/></svg>,
            Star: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            X: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Coffee: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10 2v2"/><path d="M14 2v2"/><path d="M6 2v2"/><path d="M18 8a1 1 0 0 1 1 1v2a3 3 0 0 1-3 3h-2.95a1 1 0 0 0-.768.369l-.254.332a4 4 0 0 1-3.26 1.623 4 4 0 0 1-3.296-1.402l-.125-.153A1 1 0 0 0 4.35 14H4a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h14z"/><path d="M18 14v1a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-1"/></svg>,
            ShoppingBag: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            Fuel: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="3" x2="15" y1="22" y2="22"/><line x1="4" x2="14" y1="9" y2="9"/><path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18"/><path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V9.83a2 2 0 0 0-.59-1.42L18 5"/></svg>,
            MoreHorizontal: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>,
            Sun: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            CloudSnow: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M8 15h.01"/><path d="M8 19h.01"/><path d="M12 17h.01"/><path d="M12 21h.01"/><path d="M16 15h.01"/><path d="M16 19h.01"/></svg>,
            CloudRain: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>,
            Cloud: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-3.4-3.1-6-6.5-6-3.7 0-6.6 2.8-6.9 6.4h-.1C2.1 16.4 0 18.5 0 21c0 2.2 1.8 4 4 4h13.5c2.2 0 4-1.8 4-4"/></svg>,
            Navigation2: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 19 21 12 17 5 21 12 2"/></svg>,
            Camera: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            ShoppingBasket: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m5 11 4-7"/><path d="m19 11-4-7"/><path d="M2 11h20"/><path d="m3.5 11 1.6 7.4a2 2 0 0 0 2 1.6h9.8c.9 0 1.8-.7 2-1.6l1.7-7.4"/><path d="m9 11 1 9"/><path d="m4.5 11 .1 8.1"/><path d="m19.5 11-.1 8.1"/><path d="m15 11-1 9"/></svg>,
            Image: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Newspaper: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></svg>,
            Mail: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
            UsersViewfinder: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="10" cy="10" r="7" /><path d="M21 21l-6-6" /><path d="M7 10h6" /><path d="M10 7v6" /></svg>, 
            MapLocation: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>, 
            Info: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Shield: (props)=><svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></svg>
        };

        const WeatherIcon = ({ type }) => {
            switch (type) {
                case 'sunny': return <Icons.Sun className="w-5 h-5 text-amber-500" />;
                case 'snowy': return <Icons.CloudSnow className="w-5 h-5 text-slate-400" />;
                case 'rainy': return <Icons.CloudRain className="w-5 h-5 text-blue-400" />;
                case 'cloudy': return <Icons.Cloud className="w-5 h-5 text-stone-400" />;
                default: return <Icons.CloudSnow className="w-5 h-5 text-stone-300" />;
            }
        };

        const RAW_KML_DATA = [
            { dayId: "day1", date: "12/24 (ä¸‰)", title: "è–èª•å¤œæ¡ƒåœ’ä¹‹æ—…", themeColor: "bg-[#FFCF56]", spots: [ { name: "æº«æš–çš„å®¶", lat: 25.0665752, lon: 121.5103617, desc: "æ—…ç¨‹èµ·é»ï¼Œæº–å‚™å‡ºç™¼ï¼", mapCode: "GPS" }, { name: "HARD OFFæµ·å¾·æ²ƒç¦ æ¡ƒåœ’ä¸­å£¢åº—", lat: 24.9712911, lon: 121.252971, desc: "æ—¥æœ¬äºŒæ‰‹é€£é–åº—å·¡ç¦®ï¼Œå°‹å¯¶è¶£ã€‚", mapCode: "GPS" }, { name: "çŸ³é–€æ°´åº«ç¦è¯æ¸¡å‡é£¯åº—", lat: 24.8177389, lon: 121.2430134, desc: "å…¥ä½çŸ³é–€æ°´åº«æ—ï¼Œäº«å—è–èª•æ°›åœã€‚", mapCode: "GPS" } ] },
            { dayId: "day2", date: "12/25 (å››)", title: "é¾æ½­å‰µæ„èˆ‡æ´»åŠ›æ¢ç´¢", themeColor: "bg-[#90BE6D]", spots: [ { name: "é›„ç…æ–‡å…·-æƒ³åƒåŠ›è£½é€ æ‰€", lat: 24.8418681, lon: 121.1962665, desc: "è‰²å½©èˆ‡å‰µæ„çš„é«”é©—è§€å…‰å·¥å» ã€‚", mapCode: "GPS", ticket: { adult: 500, child: 300 } }, { name: "é¾æ½­é‹å‹•å…¬åœ’å…’ç«¥éŠæˆ²å ´", lat: 24.868033, lon: 121.2187586, desc: "è®“å­©å­ç›¡æƒ…æ”¾é›»çš„æˆ¶å¤–ç©ºé–“ã€‚", mapCode: "GPS" }, { name: "æº«æš–çš„å®¶", lat: 25.0665752, lon: 121.5103617, desc: "å¹³å®‰è¿”å®¶ã€‚", mapCode: "GPS" } ] }
        ];
        const REGION_DATA = { "taoyuan": { label: "æ¡ƒåœ’/ä¸­å£¢", lat: 24.9936, lon: 121.3010, souvenirs: [ { name: "å¤§æºªè±†å¹²", desc: "æ¡ƒåœ’ç¶“å…¸åç”¢" }, { name: "é¾ç‹„èŠ±ç”Ÿç³–", desc: "é¾æ½­çŸ¥åä¼´æ‰‹ç¦®" }, { name: "ä¸­å´æœ¬èˆ–è›‹ç³•", desc: "å‚³çµ±å¤æ—©å‘³" } ], color: "text-[#FFCF56]" }, "longtan": { label: "é¾æ½­/çŸ³é–€", lat: 24.8694, lon: 121.2183, souvenirs: [ { name: "çŸ³é–€æ´»é­š", desc: "åœ¨åœ°ç‰¹è‰²æ–™ç†" }, { name: "é¾æ½­èŠ±ç”Ÿè»Ÿç³–", desc: "é¦™ç”œä¸é»ç‰™" }, { name: "å®¢å®¶èœåŒ…", desc: "å‚³çµ±ç±³é£Ÿç¾å‘³" } ], color: "text-[#90BE6D]" } };
        const NAV_BUTTONS_NEW = [
            { title: "é™„è¿‘çš„å¹³åƒ¹ç¾é£Ÿ", query: "å¹³åƒ¹ç¾é£Ÿ", icon: Icons.Utensils },
            { title: "é™„è¿‘ä¾¿åˆ©å•†åº—", query: "ä¾¿åˆ©å•†åº—", icon: Icons.Store },
            { title: "é™„è¿‘çš„å’–å•¡", query: "å’–å•¡å»³", icon: Icons.Coffee },
            { title: "é™„è¿‘çš„åŠ æ²¹ç«™", query: "åŠ æ²¹ç«™", icon: Icons.Fuel },
            { title: "é™„è¿‘çš„å…¨è¯", query: "å…¨è¯ç¦åˆ©ä¸­å¿ƒ", icon: Icons.ShoppingBasket }
        ];
        const FLIGHT_INFO_A = {
            outbound: { flight: "Drive", airline: "è‡ªé§•å‰å¾€", from: "å°åŒ—", to: "æ¡ƒåœ’", dep: "09:30", arr: "11:00", date: "12/24 (ä¸‰)", duration: "1h 30m" },
            inbound: { flight: "Drive", airline: "è‡ªé§•è¿”ç¨‹", from: "é¾æ½­", to: "å°åŒ—", dep: "16:00", arr: "17:30", date: "12/25 (å››)", duration: "1h 30m" }
        };
        const HOTEL_INFO_A = [
            { day: "12/24", name: "çŸ³é–€æ°´åº«ç¦è¯æ¸¡å‡é£¯åº—", location: "æ¡ƒåœ’é¾æ½­", desc: "æ¹–æ™¯åº¦å‡é£¯åº—", link: "https://www.google.com/maps/search/?api=1&query=çŸ³é–€æ°´åº«ç¦è¯æ¸¡å‡é£¯åº—", lat: 24.8177389, lon: 121.2430134 }
        ];
        const RENTAL_INFO_LIST = [
            { label: "è»Šè¼›", value: "è‡ªå®¶è»Š" }, { label: "é§•é§›", value: "çˆ¸çˆ¸" }, { label: "å°èˆª", value: "Google Maps / è»Šæ©Ÿ" },
            { label: "ETC", value: "å·²å®‰è£" }, { label: "ä¿éšª", value: "å·²æŠ•ä¿å¼·åˆ¶éšª/ç¬¬ä¸‰äººè²¬ä»»éšª" }, { label: "å‚™è¨»", value: "å‡ºç™¼å‰æª¢æŸ¥èƒå£“èˆ‡äº”æ²¹ä¸‰æ°´" }
        ];
        const FLIGHT_INFO_B = {
            outbound: { flight: "JX802", airline: "æ˜Ÿå®‡èˆªç©º", from: "TPE", to: "NRT", dep: "10:10", arr: "14:20", date: "2026/1/30" },
            inbound: { flight: "JX801", airline: "æ˜Ÿå®‡èˆªç©º", from: "NRT", to: "TPE", dep: "15:30", arr: "18:45", date: "2026/2/3" }
        };
        const HOTEL_INFO_B = [
            { day: "1/30", name: "Hotel Torifito Kashiwanoha", location: "åƒè‘‰æŸå¸‚" }, { day: "1/31", name: "REFå¤§å®® by Vessel Hotels", location: "åŸ¼ç‰å¤§å®®" },
            { day: "2/1", name: "HOTEL COMENTO YOKOHAMA", location: "æ©«æ¿±é—œå…§" }, { day: "2/2", name: "æ—¥å’Œé£¯åº—èˆæ¿±", location: "åƒè‘‰æµ¦å®‰" },
        ];
        const AI_GUARD_DATA_B = [
            { date: "1/30 (äº”) Fri.", spots: [ { name: "èˆªç©ºç§‘å­¸åšç‰©é¤¨", location: "æˆç”°æ©Ÿå ´æ—", tags: ["14:30"], timeHint: "14:30", icon: "âœˆï¸", url: "http://www.aeromuseum.or.jp/", strategy: "é€™è£¡æœ€ç†±é–€çš„æ˜¯ã€Œ747 æ©Ÿé ­å°è¦½ã€èˆ‡ã€Œå¤§å‹æ¨¡æ“¬é§•é§›è‰™ã€ï¼Œéœ€è¦å…¥é¤¨å¾Œé ç´„ã€‚" } ] },
            { date: "1/31 (å…­) Sat.", spots: [ { name: "è¶³ç«‹å€ç”Ÿç‰©åœ’", location: "ç«¹ä¹‹å¡šç«™", tags: ["09:30"], timeHint: "09:30", icon: "ğŸ¦‹", url: "https://seibutuen.jp/", strategy: "å†¬å­£ã€Œå¤§æº«å®¤ã€ç‰¹åˆ¥å—æ­¡è¿ï¼Œæš–æ°£å……è¶³ä¸”è´è¶é£›èˆã€‚" }, { name: "å¤§å®®éµé“åšç‰©é¤¨", location: "åŸ¼ç‰å¤§å®®", tags: ["13:00"], timeHint: "13:00", icon: "ğŸš‚", url: "https://www.railway-museum.jp/", strategy: "é–€ç¥¨å¿…é ˆæå‰è²·å¥½ã€‚æƒ³é«”é©—ã€Œè¿·ä½ é§•é§›åˆ—è»Šã€å‹™å¿…ä¸‹è¼‰å®˜æ–¹ App æŠ½ç±¤ã€‚" } ] },
            { date: "2/1 (æ—¥) Sun.", spots: [ { name: "å¤šæ‘©å…­éƒ½ç§‘å­¸é¤¨", location: "è¥¿æ±äº¬å¸‚", tags: ["09:30"], timeHint: "09:30", icon: "ğŸª", url: "https://www.tamarokuto.or.jp/", strategy: "æœ‰ã€Œé‡‘æ°ä¸–ç•Œç´€éŒ„ã€èªè­‰çš„å¤©è±¡å„€ï¼Œå»ºè­°å…ˆç¢ºèªæ˜Ÿç©ºåŠ‡å ´å ´æ¬¡ã€‚" } ] },
            { date: "2/2 (ä¸€) Mon.", spots: [ { name: "åˆå‘³é“ç´€å¿µé¤¨ æ©«æ¿±", location: "æ©«æ¿±", tags: ["10:00"], timeHint: "10:00", icon: "ğŸœ", url: "https://www.cupnoodles-museum.jp/zh-tw/yokohama/", strategy: "ã€Œæˆ‘çš„åˆå‘³é“å·¥å» ã€éå¸¸ç†±é–€ï¼Œå¼·çƒˆå»ºè­°ä¸€å€‹æœˆå‰ä¸Šç¶²é ç´„ã€‚" } ] },
        ];

        const EXCHANGE_RATE = 1.0; 
        const STAY_OPTIONS = ["30 min", "1 hr", "1.5 hr", "2 hr", "2.5 hr", "3 hr", "4 hr", "5 hr", "Overnight", "-"];
        const FAMILY_MEMBERS = ["è”£ç¿Šé½Š", "è”£å®¥æ˜‡", "é™³æ¦®èŠ³", "è”£å®—æ†"];


        // --- COMPONENTS (Merged and Refactored) ---

        // 1. DailyDetailModal (A)
        const DailyDetailModal = ({ isOpen, onClose, dayData, allExpenses, spotTicketCounts }) => {
            if (!isOpen || !dayData) return null;
            const dayExpensesList = [];
            dayData.spots.forEach(spot => {
                const spotExpenses = allExpenses[spot.id] || [];
                spotExpenses.forEach(record => {
                    const dateMatch = record.note ? record.note.match(/^(\d{4}[-/]\d{2}[-/]\d{2}\s+\d{2}:\d{2})\s+(.*)$/) : null;
                    dayExpensesList.push({ type: 'manual', spotName: spot.name, category: record.category, amount: record.amount, note: dateMatch ? dateMatch[2] : (record.note || "æ¶ˆè²»"), date: dateMatch ? dateMatch[1] : null, id: record.id });
                });
                if (spot.ticket) {
                    const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 };
                    const ticketCost = (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child);
                    if (ticketCost > 0) { dayExpensesList.push({ type: 'ticket', spotName: spot.name, category: 'ticket', amount: ticketCost, note: `é–€ç¥¨ (å¤§${counts.adult} å°${counts.child})`, id: `ticket-${spot.id}` }); }
                }
            });

            return (
                <div className="fixed inset-0 bg-stone-900/80 backdrop-blur-sm flex items-center justify-center z-[130] p-4" onClick={onClose}>
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl max-h-[70vh] flex flex-col bg-[#0f172a] border border-slate-700" onClick={e => e.stopPropagation()}>
                         <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                            <div><div className="text-xs font-bold text-slate-400 mb-1">{dayData.date}</div><h3 className="font-black text-xl text-slate-200">{dayData.title}</h3></div>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-slate-700 text-slate-400 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                            {dayExpensesList.length === 0 ? (<div className="text-center text-slate-500 py-8 flex flex-col items-center"><Icons.Wallet size={32} className="mb-2 opacity-50"/><span>æœ¬æ—¥å°šç„¡èŠ±è²»ç´€éŒ„</span></div>) : (
                                dayExpensesList.map((item, idx) => (<div key={item.id || idx} className="bg-[#1e293b] p-3 rounded-xl border border-slate-700 flex justify-between items-center"><div><div className="text-xs text-[#FFCB77] font-bold mb-0.5">{item.spotName}</div><div className="flex flex-col">{item.date && <span className="text-[10px] text-slate-500 block">{item.date}</span>}<span className="text-sm font-bold text-slate-300">{item.note}</span></div></div><div className="font-mono font-bold text-slate-200 text-lg">NT${item.amount.toLocaleString()}</div></div>))
                            )}
                        </div>
                        <div className="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center"><span className="text-sm font-bold text-slate-400 uppercase tracking-wider">Total</span><span className="text-2xl font-mono font-black text-[#FF6B6B]">NT${dayData.totalJpy.toLocaleString()}</span></div>
                    </div>
                </div>
            );
        };

        // 2. ApiKeyModal (A/B)
        const ApiKeyModal = ({ isOpen, onClose }) => {
            const [key, setKey] = useState('');
            useEffect(() => { const storedKey = localStorage.getItem('gemini_api_key'); if (storedKey) setKey(storedKey); }, [isOpen]);
            const handleSave = () => { localStorage.setItem('gemini_api_key', key.trim()); onClose(); };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-stone-800/80 backdrop-blur-sm flex items-center justify-center z-[120] p-4"><div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl">
                        <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-lg text-slate-200 flex items-center gap-2"><Icons.Settings size={20} /> è¨­å®š AI é‡‘é‘°</h3><button onClick={onClose} className="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700/50 transition-colors"><Icons.X size={20} /></button></div>
                        <p className="text-xs text-slate-400 mb-4">å…§å»ºé‡‘é‘°å·²å•Ÿç”¨ï¼è‹¥æ‚¨æœ‰è‡ªå·±çš„ Key å¯åœ¨æ­¤æ›´æ›ã€‚</p>
                        <input type="password" value={key} onChange={(e) => setKey(e.target.value)} placeholder="è²¼ä¸Š API Key (é¸å¡«)" className="w-full bg-slate-700 rounded-lg p-3 text-sm mb-4 outline-none focus:ring-2 focus:ring-[#4ECDC4] text-white"/>
                        <div className="flex gap-2"><a href="https://aistudio.google.com/app/apikey" target="_blank" className="flex-1 text-center py-2 rounded-lg border border-slate-600 text-xs font-bold text-slate-400 hover:bg-slate-700">å–å¾— Key</a><button onClick={handleSave} className="flex-1 bg-[#4ECDC4] text-white py-2 rounded-lg text-sm font-bold hover:bg-[#3dbdb4]">å„²å­˜</button></div>
                    </div>
                </div>
            );
        };

        // 3. ExpenseModal (A)
        const ExpenseModal = ({ isOpen, onClose, currentEditingSpot, expenseForm, setExpenseForm, handleImageUpload, pendingReceipts, togglePendingReceipt, removePendingReceipt, saveExpense, expenses, deleteExpense, isAnalyzingReceipt, quotaStatus }) => {
            if (!isOpen || !currentEditingSpot) return null;
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm bg-[#1e293b] border border-slate-600 flex flex-col max-h-[85vh]">
                        <h3 className="font-bold text-lg mb-4 text-slate-200 shrink-0">{currentEditingSpot.name}</h3>
                        <div className="overflow-y-auto flex-1 pr-1 -mr-1">
                            <input type="text" value={expenseForm.note} onChange={e => setExpenseForm({...expenseForm, note: e.target.value})} className="w-full bg-slate-800 p-3 rounded-xl mb-4 text-sm text-white border border-slate-600 outline-none focus:border-[#FFCB77]" placeholder="å‚™è¨»/æ‘˜è¦ (ä¾‹å¦‚: å•†åº—å)" />
                            <div className="relative mb-4">
                                <input type="number" value={expenseForm.amount} onChange={e => setExpenseForm({...expenseForm, amount: e.target.value})} className="w-full bg-slate-800 p-3 rounded-xl text-xl font-mono text-white border border-slate-600 outline-none focus:border-[#FFCB77] pr-32" placeholder="é‡‘é¡" autoFocus />
                                <div className="absolute right-12 top-1/2 -translate-y-1/2 flex items-center gap-2 z-10 pointer-events-none">
                                    <div className="relative pointer-events-auto"><input type="file" accept="image/*" id="gallery-upload" className="hidden" multiple onChange={handleImageUpload}/><label htmlFor="gallery-upload" className={`p-1.5 rounded-lg cursor-pointer flex items-center justify-center transition-colors ${isAnalyzingReceipt ? 'text-slate-600 cursor-not-allowed' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}><Icons.Image size={20} /></label></div>
                                    <div className="relative pointer-events-auto"><input type="file" accept="image/*" capture="environment" id="camera-upload" className="hidden" onChange={handleImageUpload}/><label htmlFor="camera-upload" className={`p-1.5 rounded-lg cursor-pointer flex items-center justify-center transition-colors ${isAnalyzingReceipt ? 'text-[#FFCB77] animate-pulse' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}>{isAnalyzingReceipt ? <Icons.Loader2 className="animate-spin" size={20} /> : <Icons.Camera size={20} />}</label></div>
                                </div>
                            </div>
                            {pendingReceipts.length > 0 && (
                                <div className="mb-4 space-y-2">
                                    <div className="flex justify-between items-center"><div className="text-xs font-bold text-[#4ECDC4] flex items-center gap-1"><Icons.Sparkles size={12}/> AI è¾¨è­˜çµæœ ({pendingReceipts.filter(p=>p.isChecked).length})</div><div className={`text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 ${quotaStatus.type === 'error' ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}><div className={`w-1.5 h-1.5 rounded-full ${quotaStatus.type === 'error' ? 'bg-red-500 animate-pulse' : 'bg-green-500'}`}></div>{quotaStatus.text}</div></div>
                                    <div className="bg-slate-900/50 rounded-xl p-2 border border-[#4ECDC4]/30 space-y-2 max-h-40 overflow-y-auto">
                                        {pendingReceipts.map(item => (<div key={item.id} className={`flex items-center gap-3 p-2 rounded-lg transition-colors ${item.isChecked ? 'bg-[#4ECDC4]/10' : 'opacity-50'}`}><input type="checkbox" checked={item.isChecked} onChange={() => togglePendingReceipt(item.id)} className="w-4 h-4 rounded border-slate-500 accent-[#4ECDC4] cursor-pointer shrink-0" /><div className="flex-1 min-w-0">{item.isAnalyzing ? (<div className="flex items-center gap-2 text-xs text-slate-400"><Icons.Loader2 size={12} className="animate-spin"/> {item.note}</div>) : (<><div className={`font-bold text-sm truncate ${item.note.includes('é¡åº¦') || item.note.includes('å¤±æ•—') ? 'text-red-400' : 'text-slate-200'}`}>{item.note || 'æœªå‘½å'}</div>{item.amount > 0 && <div className="text-xs text-[#4ECDC4] font-mono">NT${item.amount}</div>}</>)}</div><button onClick={() => removePendingReceipt(item.id)} className="text-slate-500 hover:text-red-400 p-1"><Icons.X size={14} /></button></div>))}
                                    </div>
                                </div>
                            )}
                            <div className="pt-4 border-t border-dashed border-slate-700">
                                <div className="text-xs font-bold text-slate-400 mb-3">æ­·å²ç´€éŒ„</div>
                                <div className="space-y-2">
                                    {(expenses[currentEditingSpot.id] || []).map(record => {
                                        const dateMatch = record.note ? record.note.match(/^(\d{4}[-/]\d{2}[-/]\d{2}\s+\d{2}:\d{2})\s+(.*)$/) : null;
                                        return (<div key={record.id} className="flex justify-between items-center text-sm bg-slate-800 p-3 rounded-xl border border-slate-600"><div className="flex flex-col">{dateMatch ? <><span className="text-[10px] text-slate-500 block mb-0.5">{dateMatch[1]}</span><span className="font-bold text-slate-200 text-base">{dateMatch[2]}</span></> : <span className="font-bold text-slate-300">{record.note || "æ¶ˆè²»"}</span>}</div><div className="flex items-center gap-3"><span className="font-mono font-bold text-slate-100">NT${record.amount}</span><button onClick={() => deleteExpense(currentEditingSpot.id, record.id)} className="text-slate-400 hover:text-red-400"><Icons.X size={16} /></button></div></div>);
                                    })}
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-2 mt-4 shrink-0"><button onClick={onClose} className="flex-1 py-3 text-slate-400 hover:text-white">å–æ¶ˆ</button><button onClick={saveExpense} className="flex-1 bg-[#FFCB77] text-slate-900 rounded-xl font-bold shadow-[0_4px_0px_#d9aa5b] active:translate-y-[2px] active:shadow-none">{pendingReceipts.filter(p => p.isChecked).length > 0 ? `å„²å­˜ (${pendingReceipts.filter(p => p.isChecked).length + (expenseForm.amount ? 1 : 0)}ç­†)` : 'å„²å­˜'}</button></div>
                    </div>
                </div>
            );
        };

        // 4. EmailModal (A)
        const EmailModal = ({ isOpen, onClose, emailInput, setEmailInput, handleSendEmail, isSendingEmail }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-stone-900/80 backdrop-blur-sm flex items-center justify-center z-[130] p-4"><div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl bg-[#1e293b] border border-slate-700">
                        <h3 className="font-bold text-lg mb-2 text-slate-200 flex items-center gap-2"><Icons.Mail size={20} className="text-[#4ECDC4]" /> å¯„é€èŠ±è²»å ±è¡¨</h3>
                        <p className="text-xs text-slate-400 mb-4">å°‡æœ¬æ¬¡æ—…ç¨‹çš„æ‰€æœ‰èŠ±è²»æ˜ç´°è£½ä½œæˆè¡¨æ ¼ï¼Œå¯„é€åˆ°æ‚¨çš„ä¿¡ç®±ã€‚</p>
                        <label className="block text-xs font-bold text-slate-300 mb-1">æ”¶ä»¶äººä¿¡ç®±</label>
                        <input type="email" value={emailInput} onChange={(e) => setEmailInput(e.target.value)} placeholder="your@email.com" className="w-full bg-slate-800 p-3 rounded-xl mb-6 text-sm text-white border border-slate-600 outline-none focus:border-[#4ECDC4]" />
                        <div className="flex gap-2"><button onClick={onClose} className="flex-1 py-2 text-slate-400 hover:text-white transition-colors" disabled={isSendingEmail}>å–æ¶ˆ</button><button onClick={handleSendEmail} className="flex-1 bg-[#4ECDC4] text-white rounded-xl font-bold py-2 shadow-lg hover:bg-[#3dbdb4] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" disabled={isSendingEmail}>{isSendingEmail ? <><Icons.Loader2 size={16} className="animate-spin" /> ç™¼é€ä¸­...</> : 'ç¢ºèªç™¼é€'}</button></div>
                    </div>
                </div>
            );
        };
        
        // 5. AI Guard Tab (B)
        const AiGuardTab = ({ aiLoading, checkFlight, flightAnalysis, checkHotel, hotelAnalysis, AI_GUARD_DATA, checkSpot, spotAnalysis, aiInput, setAiInput, analyzeGeneral, aiGeneralResult, setIsKeyModalOpen }) => {
            return (
                <div className="animate-in fade-in slide-in-from-bottom-6 duration-700 space-y-8">
                    <header className="glass-panel p-6 rounded-2xl border border-blue-500/30">
                        <h1 className="text-2xl font-black text-white flex items-center gap-2">
                            <span className="bg-blue-600 p-2 rounded-lg"><Icons.Shield size={24}/></span> 
                            AI æ—…éŠé˜²é›·åŠ©æ‰‹
                        </h1>
                        <p className="text-slate-400 text-sm mt-2">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œåˆ©ç”¨ Gemini AI çµåˆ Google Search æŸ¥è­‰è³‡è¨Šã€‚</p>
                    </header>
                    
                    {/* èˆªç­æª¢æŸ¥ */}
                    <section className="glass-panel p-6 rounded-2xl border border-slate-700">
                        <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Icons.Plane className="text-blue-400"/> èˆªç­é˜²é›· (ç¯„ä¾‹: æ±äº¬è¡Œ)</h3>
                        <div className="bg-slate-800 p-4 rounded-xl mb-4 border border-slate-600">
                            <div className="flex justify-between text-sm text-slate-300 mb-2"><span>å»: {FLIGHT_INFO_B.outbound.flight}</span><span>{FLIGHT_INFO_B.outbound.date}</span></div>
                            <div className="flex justify-between text-sm text-slate-300"><span>å›: {FLIGHT_INFO_B.inbound.flight}</span><span>{FLIGHT_INFO_B.inbound.date}</span></div>
                        </div>
                        {flightAnalysis && <div className="bg-blue-900/30 p-4 rounded-xl border border-blue-500/30 text-sm text-blue-200 mb-4"><ReactMarkdown>{flightAnalysis}</ReactMarkdown></div>}
                        <button onClick={checkFlight} disabled={aiLoading} className="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold flex justify-center items-center gap-2 transition-colors">
                            {aiLoading && !flightAnalysis ? <Icons.Loader2 className="animate-spin"/> : <Icons.Search size={16}/>} AI é©—è­‰èˆªç­
                        </button>
                    </section>

                    {/* ä½å®¿æª¢æŸ¥ */}
                    <section className="glass-panel p-6 rounded-2xl border border-slate-700">
                        <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Icons.Hotel className="text-[#FFCB77]"/> ä½å®¿é˜²é›· (ç¯„ä¾‹: æ±äº¬è¡Œ)</h3>
                        <div className="space-y-4">
                            {HOTEL_INFO_B.map((h,i) => (
                                <div key={i} className="bg-slate-800 p-4 rounded-xl border border-slate-600">
                                    <div className="flex justify-between items-start mb-2">
                                        <div><div className="font-bold text-slate-200 text-sm">{h.name}</div><div className="text-xs text-slate-400 mt-1">{h.location}</div></div>
                                        <button onClick={()=>checkHotel(h.name)} disabled={aiLoading} className="text-xs bg-[#FFCB77]/20 text-[#FFCB77] px-3 py-1.5 rounded-lg border border-[#FFCB77] hover:bg-[#FFCB77] hover:text-slate-900 transition-colors flex items-center gap-1 font-bold shrink-0">
                                            <Icons.Search size={12}/> æƒé›·
                                        </button>
                                    </div>
                                    {hotelAnalysis[h.name] && <div className="text-sm text-slate-300 bg-black/20 p-3 rounded-lg mt-2 border border-white/5"><ReactMarkdown>{hotelAnalysis[h.name]}</ReactMarkdown></div>}
                                </div>
                            ))}
                        </div>
                    </section>

                    {/* æ™¯é»æª¢æŸ¥ */}
                    <section className="space-y-4">
                        <h3 className="text-xl font-bold text-white flex items-center gap-2 px-2"><Icons.Sparkles className="w-6 h-6 text-yellow-400" />å†¬å­£ç²¾é¸æ™¯é» & AI æƒé›· (ç¯„ä¾‹: æ±äº¬è¡Œ)</h3>
                        
                        {AI_GUARD_DATA_B.map((dayGroup, idx) => (
                            <div key={idx} className="space-y-3">
                                <div className="sticky top-20 z-40 bg-[#0B1121]/95 backdrop-blur-sm py-2 px-4 border-b border-slate-700 text-sm font-bold text-blue-300 rounded-lg shadow-md">{dayGroup.date}</div>
                                {dayGroup.spots.map((spot, sIdx) => {
                                    const resultKey = spot.name + `2026å¹´${dayGroup.date} ${spot.timeHint || ''}`.trim();
                                    return (
                                        <div key={sIdx} className="glass-panel rounded-xl p-5 border-l-4 border-l-blue-500 hover:border-l-blue-400 transition-all">
                                            <div className="flex items-start gap-4">
                                                <div className="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center text-2xl shrink-0"><span className="text-2xl">{spot.icon}</span></div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-start"><h4 className="font-bold text-lg text-white mb-1">{spot.name}</h4><a href={spot.url} target="_blank" className="text-slate-400 hover:text-white"><Icons.ExternalLink className="w-4 h-4" /></a></div>
                                                    <div className="flex flex-wrap gap-2 mb-3">
                                                        <span className="text-xs bg-slate-700/50 text-slate-300 px-2 py-0.5 rounded flex items-center gap-1"><Icons.MapPin className="w-3 h-3" /> {spot.location}</span>
                                                        <span className="text-xs bg-blue-900/30 text-blue-200 px-2 py-0.5 rounded border border-blue-500/20">{spot.tags[0]}</span>
                                                    </div>
                                                    <div className="strategy-box p-3 rounded-r-lg text-sm text-slate-200 mb-3 relative group">
                                                        <div className="font-bold text-amber-400 text-xs mb-1 flex items-center gap-1"><Icons.Sun className="w-3 h-3" /> é”äººç­†è¨˜</div>
                                                        {spot.strategy}
                                                    </div>
                                                    {spotAnalysis[resultKey] && (<div className="mb-3 p-3 bg-indigo-900/30 border border-indigo-500/30 rounded-lg text-sm text-indigo-100 animate-in fade-in"><div className="flex items-center gap-2 mb-2 text-indigo-300 font-bold border-b border-indigo-500/20 pb-1"><Icons.Bot className="w-4 h-4" /> AI æƒé›·å ±å‘Š</div><ReactMarkdown>{spotAnalysis[resultKey]}</ReactMarkdown></div>)}
                                                    <button onClick={() => checkSpot(spot, dayGroup.date)} disabled={aiLoading} className="w-full py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white rounded-lg text-sm font-medium transition-all shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-2">
                                                        {aiLoading ? <Icons.Loader2 className="animate-spin w-4 h-4"/> : <Icons.Check className="w-4 h-4"/>} AI é˜²é›·é©—è­‰ {spot.timeHint ? `(${spot.timeHint})` : ''}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ))}
                    </section>

                    {/* é€šç”¨æª¢æŸ¥ */}
                    <section className="glass-panel p-6 rounded-2xl border border-slate-700">
                        <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Icons.Shield className="text-green-400"/> é€šç”¨æƒ…å ±åˆ†æ</h3>
                        <textarea value={aiInput} onChange={e=>setAiInput(e.target.value)} placeholder="è²¼ä¸Šç¶²è·¯æ”»ç•¥æˆ–é¤å»³è©•è«–..." className="w-full h-32 bg-slate-800 rounded-xl p-3 text-sm text-white outline-none focus:ring-2 focus:ring-green-500 mb-3 border border-slate-600 resize-none"/>
                        <button onClick={analyzeGeneral} disabled={aiLoading||!aiInput} className="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg font-bold transition-colors">é–‹å§‹åˆ†æ</button>
                        {aiGeneralResult && <div className="mt-4 p-4 bg-slate-800 rounded-xl text-sm text-slate-300 border border-slate-600"><ReactMarkdown>{aiGeneralResult}</ReactMarkdown></div>}
                    </section>

                </div>
            );
        };


        // --- MAIN APP COMPONENT ---
        function App() {
            // A Tabs: 'itinerary', 'info', 'stats' | B Tab: 'ai_guard'
            const [activeTab, setActiveTab] = useState('itinerary'); 
            const [selectedDay, setSelectedDay] = useState('all'); 
            
            // --- Info States ---
            const [userLocation, setUserLocation] = useState(null);
            const [isLocating, setIsLocating] = useState(false);
            const [locationError, setLocationError] = useState(null);
            const [infoRegion, setInfoRegion] = useState("taoyuan"); 
            const [aiSouvenirs, setAiSouvenirs] = useState(null);
            const [isAiSouvenirLoading, setIsAiSouvenirLoading] = useState(false);
            const [aiNews, setAiNews] = useState(null);
            const [isAiNewsLoading, setIsAiNewsLoading] = useState(false);
            
            // --- Itinerary States ---
            const [dayStartTimes, setDayStartTimes] = useState(() => { const initial = {}; RAW_KML_DATA.forEach(day => initial[day.dayId] = "09:00"); const saved = localStorage.getItem('2025_ny_trip_start'); return saved ? JSON.parse(saved) : initial; });
            const [actualDepartures, setActualDepartures] = useState(() => { const saved = localStorage.getItem('2025_ny_trip_deps'); return saved ? JSON.parse(saved) : {}; });
            const [stays, setStays] = useState(() => { const saved = localStorage.getItem('2025_ny_trip_stays'); return saved ? JSON.parse(saved) : {}; });
            const [transportModes, setTransportModes] = useState({});
            const [tripData, setTripData] = useState([]);
            const [activeTipSpotId, setActiveTipSpotId] = useState(null);
            const [aiTips, setAiTips] = useState({});
            const [isTipLoading, setIsTipLoading] = useState(false);
            const [spotTicketCounts, setSpotTicketCounts] = useState(() => { const saved = localStorage.getItem('2025_ny_trip_tickets'); return saved ? JSON.parse(saved) : {}; });

            // --- Stats & Expense States ---
            const [expenses, setExpenses] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isKeyModalOpen, setIsKeyModalOpen] = useState(false);
            const [currentEditingSpot, setCurrentEditingSpot] = useState(null);
            const [expenseForm, setExpenseForm] = useState({ category: 'food', amount: '', note: '' });
            const [isAnalyzingReceipt, setIsAnalyzingReceipt] = useState(false);
            const [pendingReceipts, setPendingReceipts] = useState([]);
            const [quotaStatus, setQuotaStatus] = useState({ type: 'normal', text: 'API é¡åº¦æ­£å¸¸' });
            
            // --- Calculator States ---
            const [calcInput, setCalcInput] = useState("");
            const [calcResult, setCalcResult] = useState("");
            
            // --- Photo Search States ---
            const [photoSearchLocation, setPhotoSearchLocation] = useState("");
            const [photoSearchPeople, setPhotoSearchPeople] = useState([]);
            const [photoSearchStatus, setPhotoSearchStatus] = useState({ text: "è«‹è¼¸å…¥åœ°é»æˆ–é»æ“Šå®šä½", type: "normal" });
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerInstanceRef = useRef(null);

            // --- Email States ---
            const [isDailyDetailOpen, setIsDailyDetailOpen] = useState(false);
            const [selectedDailyStats, setSelectedDailyStats] = useState(null);
            const [isEmailModalOpen, setIsEmailModalOpen] = useState(false);
            const [emailInput, setEmailInput] = useState("");
            const [isSendingEmail, setIsSendingEmail] = useState(false);

            // --- AI Guard (B) States ---
            const [aiLoading, setAiLoading] = useState(false);
            const [flightAnalysis, setFlightAnalysis] = useState(null);
            const [hotelAnalysis, setHotelAnalysis] = useState({});
            const [spotAnalysis, setSpotAnalysis] = useState({});
            const [aiInput, setAiInput] = useState("");
            const [aiGeneralResult, setAiGeneralResult] = useState("");


            // --- PERSISTENCE & INITIALIZATION ---
            useEffect(() => { const saved = localStorage.getItem('2025_ny_trip_exp'); if (saved) { try { const parsed = JSON.parse(saved); if (parsed && typeof parsed === 'object') { setExpenses(parsed); } } catch(e) {} } }, []);
            useEffect(() => { localStorage.setItem('2025_ny_trip_exp', JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem('2025_ny_trip_start', JSON.stringify(dayStartTimes)); }, [dayStartTimes]);
            useEffect(() => { localStorage.setItem('2025_ny_trip_deps', JSON.stringify(actualDepartures)); }, [actualDepartures]);
            useEffect(() => { localStorage.setItem('2025_ny_trip_stays', JSON.stringify(stays)); }, [stays]);
            useEffect(() => { localStorage.setItem('2025_ny_trip_tickets', JSON.stringify(spotTicketCounts)); }, [spotTicketCounts]);
            useEffect(() => { if (window.emailjs) { window.emailjs.init("mYOFMMnqLdDxR0wjj"); } }, []);


            // --- Core Logic ---
            // Recalculate Trip Data (A)
             useEffect(() => {
                setTripData(prevData => {
                     return RAW_KML_DATA.map(day => {
                        const startTimeStr = dayStartTimes[day.dayId] || "09:00";
                        let currentMinutes = timeToMinutes(startTimeStr);
                        const processedSpots = day.spots.map((rawSpot, index) => {
                            const spotId = `${day.dayId}-s${index}`;
                            const stayStr = stays[spotId] || "1.5 hr";
                            const stayMinutes = parseStayDuration(stayStr);
                            const arrivalTimeStr = minutesToTimeStr(currentMinutes);
                            let departureMinutes;
                            let isDeparted = false;
                            let actualDepTime = null;
                            if (actualDepartures[spotId]) {
                                actualDepTime = actualDepartures[spotId];
                                departureMinutes = timeToMinutes(actualDepTime);
                                isDeparted = true;
                            } else {
                                departureMinutes = currentMinutes + stayMinutes;
                            }
                            const departureTimeStr = minutesToTimeStr(departureMinutes);
                            let nextStopInfo = null;
                            let travelMinutes = 0;
                            if (index < day.spots.length - 1) {
                                const nextSpot = day.spots[index + 1];
                                const dist = getDistanceFromLatLonInKm(rawSpot.lat, rawSpot.lon, nextSpot.lat, nextSpot.lon);
                                const mode = transportModes[spotId] || 'car';
                                const speed = mode === 'car' ? 40 : 4; 
                                travelMinutes = Math.round((dist / speed) * 60);
                                const displayDriveMins = Math.round((dist / 40) * 60); 
                                const displayWalkMins = Math.round((dist / 4) * 60);
                                nextStopInfo = {
                                    name: nextSpot.name, distance: `${dist} km`,
                                    driveTime: displayDriveMins > 60 ? `${Math.floor(displayDriveMins/60)}hr ${displayDriveMins%60}m` : `${displayDriveMins}m`,
                                    walkTime: displayWalkMins > 60 ? `${Math.floor(displayWalkMins/60)}hr ${displayWalkMins%60}m` : `${displayWalkMins}m`,
                                    navLink: `https://www.google.com/maps/dir/?api=1&origin=$${rawSpot.lat},${rawSpot.lon}&destination=${nextStop.lat},${nextStop.lon}&travelmode=driving`
                                };
                            }
                            currentMinutes = departureMinutes + travelMinutes;
                            return { ...rawSpot, id: spotId, time: arrivalTimeStr, stay: stayStr, departureTime: departureTimeStr, isDeparted: isDeparted, actualDepTime: actualDepTime, mapcodeDisplay: rawSpot.mapCode || "GPS", weather: ["sunny", "cloudy"][Math.floor(Math.random()*2)], temp: "16Â°C", gmapLink: `https://www.google.com/maps/search/?api=1&query=$${rawSpot.lat},${rawSpot.lon}`, nextStop: nextStopInfo, ticket: rawSpot.ticket || null };
                        });
                        return { ...day, spots: processedSpots };
                    });
                });
            }, [dayStartTimes, actualDepartures, transportModes, stays]);

            // Stats Calculation (A)
            const stats = useMemo(() => { 
                let totalJpy = 0; 
                const currentExpenses = expenses || {};
                Object.values(currentExpenses).forEach(recs => { if (Array.isArray(recs)) { recs.forEach(r => totalJpy += (r.amount || 0)); } });
                if (tripData) { tripData.forEach(day => { if (day.spots) { day.spots.forEach(spot => { if (spot.ticket) { const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 }; totalJpy += (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child); } }); } }); }
                return { totalJpy }; 
            }, [expenses, tripData, spotTicketCounts]);

            const dailyStats = useMemo(() => {
                if (!tripData) return [];
                const currentExpenses = expenses || {};
                return tripData.map(day => {
                    let dayTotal = 0;
                    if (day.spots) {
                        day.spots.forEach(spot => {
                            const spotExpenses = currentExpenses[spot.id] || [];
                            if (Array.isArray(spotExpenses)) { dayExpenses.forEach(e => dayTotal += (e.amount || 0)); }
                            if (spot.ticket) { const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 }; dayTotal += (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child); }
                        });
                    }
                    return { ...day, totalJpy: dayTotal, totalTwd: dayTotal * EXCHANGE_RATE };
                });
            }, [expenses, tripData, spotTicketCounts]);


            // --- Handlers (A) ---
            const handleTransportToggle = (spotId) => { setTransportModes(prev => ({ ...prev, [spotId]: prev[spotId] === 'walk' ? 'car' : 'walk' })); };
            const handleStayChangeNew = (spotId, newStay) => { setStays(prev => ({ ...prev, [spotId]: newStay })); };
            const handleDayStartTimeChange = (dayId, newTime) => { setDayStartTimes(prev => ({ ...prev, [dayId]: newTime })); };
            const handleDepartureToggle = (spotId) => { setActualDepartures(prev => { const newState = { ...prev }; if (newState[spotId]) { delete newState[spotId]; } else { const now = new Date(); const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; newState[spotId] = timeStr; } return newState; }); };
            const getTicketCounts = (spotId) => spotTicketCounts[spotId] || { adult: 2, child: 2 };
            const updateSpotTicketCount = (spotId, type, delta) => { setSpotTicketCounts(prev => { const current = prev[spotId] || { adult: 2, child: 2 }; const newValue = Math.max(0, current[type] + delta); return { ...prev, [spotId]: { ...current, [type]: newValue } }; }); };
            const fetchAiSouvenirs = async (lat, lon) => { setIsAiSouvenirLoading(true); setAiSouvenirs(null); try { const prompt = `æˆ‘ç¾åœ¨åœ¨å°ç£çš„åº§æ¨™: ç·¯åº¦ ${lat}, ç¶“åº¦ ${lon}ã€‚è«‹æ¨è–¦ 3 å€‹é€™å€‹åœ°é»é™„è¿‘å¿…è²·çš„çŸ¥åä¼´æ‰‹ç¦®æˆ–åœŸç”¢ã€‚è«‹ç›´æ¥å›å‚³ä¸€å€‹ JSON Arrayï¼Œæ ¼å¼å¦‚ä¸‹ï¼Œä¸è¦æœ‰ Markdown æ¨™è¨˜æˆ–å…¶ä»–æ–‡å­—ï¼š[ {"name": "ä¼´æ‰‹ç¦®åç¨±", "desc": "ç°¡çŸ­ä»‹ç´¹(20å­—å…§)"}, {"name": "ä¼´æ‰‹ç¦®åç¨±", "desc": "ç°¡çŸ­ä»‹ç´¹(20å­—å…§)"}, {"name": "ä¼´æ‰‹ç¦®åç¨±", "desc": "ç°¡çŸ­ä»‹ç´¹(20å­—å…§)"} ]`; let text = await generateGeminiContent(prompt, null, true); text = text.replace(/```json/g, '').replace(/```/g, '').trim(); const data = JSON.parse(text); if (Array.isArray(data)) { setAiSouvenirs(data); } else { throw new Error("Format error"); } } catch (e) { console.error("AI Souvenir Error", e); setAiSouvenirs([{name: "æ¨è–¦å¤±æ•—", desc: "ç„¡æ³•å–å¾— AI æ¨è–¦ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"}]); } finally { setIsAiSouvenirLoading(false); } };
            const fetchAiNews = async (lat, lon) => { setIsAiNewsLoading(true); setAiNews(null); try { const prompt = `æˆ‘ç¾åœ¨åœ¨å°ç£çš„åº§æ¨™: ç·¯åº¦ ${lat}, ç¶“åº¦ ${lon}ã€‚è«‹åˆ†æé€™å€‹åœ°é»(è«‹è‡ªè¡Œåˆ¤æ–·è¡Œæ”¿å€)ï¼Œä¸¦åˆ—å‡º 4 å€‹èˆ‡æ­¤åœ°é«˜åº¦ç›¸é—œçš„ã€Œæ–°èé—œéµå­—ã€æˆ–ã€Œé—œæ³¨ç„¦é»ã€ã€‚è«‹ä¾ç…§ã€Œé‡è¦æ€§ã€èˆ‡ã€Œç†±é–€åº¦ã€æ’åºï¼Œä¸¦å„ªå…ˆé—œæ³¨ä»¥ä¸‹é¢å‘ï¼š1. **æœ€æ–°ç†±é–€æ—…éŠæƒ…å ±** (å¦‚: æ–°é–‹å¹•æ™¯é»ã€IGæ‰“å¡ç†±é»ã€å­£ç¯€é™å®šèŠ±æµ·/å¸‚é›†) 2. **äº¤é€šèˆ‡æ—…éŠå®‰å…¨** (å¦‚: æ˜“è‚‡äº‹è·¯æ®µã€å±±å€è·¯æ³ã€è§€å…‰å€æ²»å®‰ã€äº¤é€šç®¡åˆ¶) 3. **å±…ä½èˆ‡ç’°å¢ƒå®‰å…¨** (å¦‚: å¤©å‘/æ–½å·¥å·¥å®‰ã€æ·¹æ°´æ½›å‹¢ã€æ²»å®‰ç†±é»ã€é˜²ç½è­¦å ±) 4. **åœ¨åœ°ç†±é–€æ°‘ç”Ÿè­°é¡Œ** (å¦‚: äº¤é€šå»ºè¨­ã€å¤§å‹æ´»å‹•å½±éŸ¿) è«‹ç›´æ¥å›å‚³ä¸€å€‹ JSON Arrayï¼Œæ ¼å¼å¦‚ä¸‹ï¼Œä¸è¦æœ‰ Markdown æ¨™è¨˜æˆ–å…¶ä»–æ–‡å­—ï¼š[ {"title": "é¡¯ç¤ºæ¨™é¡Œ", "query": "æœå°‹é—œéµå­—"}, {"title": "é¡¯ç¤ºæ¨™é¡Œ", "query": "æœå°‹é—œéµå­—"}, {"title": "é¡¯ç¤ºæ¨™é¡Œ", "query": "æœå°‹é—œéµå­—"}, {"title": "é¡¯ç¤ºæ¨™é¡Œ", "query": "æœå°‹é—œéµå­—"} ]`; let text = await generateGeminiContent(prompt, null, true); text = text.replace(/```json/g, '').replace(/```/g, '').trim(); const data = JSON.parse(text); if (Array.isArray(data)) { setAiNews(data); } else { throw new Error("Format error"); } } catch (e) { console.error("AI News Error", e); setAiNews([{ title: "åœ¨åœ°ç†±é–€æ™¯é»", query: "é™„è¿‘ ç†±é–€æ™¯é» æ–°è" }, { title: "äº¤é€šèˆ‡å®‰å…¨è³‡è¨Š", query: "é™„è¿‘ äº¤é€šå®‰å…¨ æ–°è" }]); } finally { setIsAiNewsLoading(false); } };
            const handleGetLocation = () => { if (!navigator.geolocation) { setLocationError("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½"); return; } setIsLocating(true); setLocationError(null); const options = { enableHighAccuracy: true, timeout: 30000, maximumAge: 600000 }; navigator.geolocation.getCurrentPosition( (position) => { setUserLocation({ lat: position.coords.latitude, lon: position.coords.longitude }); setIsLocating(false); fetchAiSouvenirs(position.coords.latitude, position.coords.longitude); fetchAiNews(position.coords.latitude, position.coords.longitude); }, (error) => { setLocationError("å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèª Wi-Fi æˆ– GPS å·²é–‹å•Ÿ"); setIsLocating(false); }, options ); };
            const handleGetSpotTip = async (spot, date) => { if (activeTipSpotId === spot.id) { setActiveTipSpotId(null); return; } setActiveTipSpotId(spot.id); if (aiTips[spot.id]) return; setIsTipLoading(true); try { const prompt = `é‡å°æ™¯é»ã€Œ${spot.name}ã€ï¼Œé è¨ˆé€ è¨ªæ—¥æœŸç‚ºã€Œ${date}ã€ã€‚è«‹åˆ©ç”¨ Google Search "ä¸»å‹•æŸ¥è©¢" ç•¶å¤©çš„æœ€æ–°ç‡Ÿæ¥­å…¬å‘Šã€FB ç²‰çµ²é è²¼æ–‡æˆ–å®˜ç¶²è³‡è¨Šã€‚è«‹æ‰®æ¼”å°ˆæ¥­å°éŠï¼Œæä¾›ã€Œé˜²é›·æ—…éŠæ”»ç•¥ã€ï¼šâœ… **ç‡Ÿæ¥­ç‹€æ³é æ¸¬**ï¼šæ ¹æ“šæœå°‹çµæœï¼Œæ˜ç¢ºå‘Šè¨´æˆ‘ç•¶å¤©æ˜¯å¦é–‹æ”¾ï¼Ÿæœ‰ç„¡è·¨å¹´/å…ƒæ—¦ç‰¹æ®Šæ´»å‹•ï¼Ÿ(è‹¥æœå°‹ä¸åˆ°ç¢ºåˆ‡å…¬å‘Šï¼Œè«‹å›ç­”ã€Œå»ºè­°ç•¶å¤©è‡´é›»ç¢ºèªã€)ã€‚âš ï¸ **é¢¨éšªè©•ä¼°**ï¼šæ˜¯å¦æœ‰æ•´ä¿®ã€äººæ½®ç®¡åˆ¶æˆ–éœ€é ç´„ï¼ŸğŸ’¡ **æ¨è–¦å‚™æ¡ˆ**ï¼šè¬ä¸€æ²’é–‹æˆ–äººå¤ªå¤šï¼Œæ¨è–¦é™„è¿‘è»Šç¨‹ 10 åˆ†é˜å…§çš„ä¸€å€‹æ›¿ä»£æ™¯é»æˆ–ç¾é£Ÿã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£å°ˆæ¥­è²¼å¿ƒï¼Œæ¢åˆ—å¼å‘ˆç¾ï¼Œç¸½å­—æ•¸ 150 å­—ä»¥å…§ã€‚`; const tip = await generateGeminiContent(prompt, null, true); setAiTips(prev => ({ ...prev, [spot.id]: tip })); } catch (error) { if (error.message.includes('NO_API_KEY')) { setAiTips(prev => ({ ...prev, [spot.id]: "æ‰¾ä¸åˆ° API Keyï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚" })); setIsKeyModalOpen(true); } else { setAiTips(prev => ({ ...prev, [spot.id]: `é€£ç·šéŒ¯èª¤ (${error.message})` })); } } finally { setIsTipLoading(false); } };
            const handleOpenMap = () => { let points = []; if (selectedDay === 'all') { tripData.forEach(day => { day.spots.forEach(spot => { const coord = `${spot.lat},${spot.lon}`; if (points.length === 0 || points[points.length - 1] !== coord) { points.push(coord); } }); }); } else { const currentDay = tripData.find(d => d.dayId === selectedDay); if (currentDay) { points = currentDay.spots.map(s => `${s.lat},${s.lon}`); } } if (points.length > 1 && points[0] !== points[points.length - 1]) { points.push(points[0]); } if (points.length > 0) { window.open(`https://www.google.com/maps/dir/$${points.join('/')}`, '_blank'); } };
            const openExpenseModal = (spot) => { setCurrentEditingSpot(spot); setExpenseForm({ category: 'food', amount: '', note: '' }); setPendingReceipts([]); setQuotaStatus({ type: 'normal', text: 'API é¡åº¦æ­£å¸¸' }); setIsModalOpen(true); };
            const saveExpense = () => { const newRecords = []; if (expenseForm.amount && !isNaN(expenseForm.amount)) { newRecords.push({ id: Date.now(), category: expenseForm.category, amount: parseInt(expenseForm.amount), note: expenseForm.note }); } pendingReceipts.forEach((p, idx) => { if (p.isChecked && !p.isAnalyzing && p.amount > 0) { newRecords.push({ id: Date.now() + idx + 1, category: expenseForm.category, amount: parseInt(p.amount), note: p.note }); } }); if (newRecords.length > 0) { const spotId = currentEditingSpot.id; setExpenses(prev => ({ ...prev, [spotId]: [...(prev[spotId] || []), ...newRecords] })); } setIsModalOpen(false); };
            const deleteExpense = (spotId, recordId) => { setExpenses(prev => ({ ...prev, [spotId]: prev[spotId].filter(r => r.id !== recordId) })); };
            const togglePendingReceipt = (id) => { setPendingReceipts(prev => prev.map(p => p.id === id ? { ...p, isChecked: !p.isChecked } : p)); };
            const removePendingReceipt = (id) => { setPendingReceipts(prev => prev.filter(p => p.id !== id)); };
            const handleImageUpload = async (e) => { 
                const files = Array.from(e.target.files); 
                if (files.length === 0) return; 
                const inputElement = e.target; 
                const newItems = files.map(file => ({ id: Math.random().toString(36).substr(2, 9), file, amount: 0, note: 'åˆ†æä¸­...', isAnalyzing: true, isChecked: true })); 
                setPendingReceipts(prev => [...prev, ...newItems]); 
                setIsAnalyzingReceipt(true); 
                setQuotaStatus({ type: 'normal', text: 'é«˜é€Ÿåˆ†æä¸­ (Paid Key)' }); 
                await Promise.all(newItems.map(async (item) => { 
                    return new Promise((resolve) => { 
                        const reader = new FileReader(); 
                        reader.onloadend = async () => { 
                            const base64String = reader.result; 
                            try { 
                                const prompt = `Analyze this receipt image. Extract: 1. Total amount. 2. Store name. 3. Date. Return JSON: {"amount", "store", "date"}.`; 
                                let responseText = await generateGeminiContent(prompt, base64String); 
                                let result; const jsonMatch = responseText.match(/\{[\s\S]*\}/); 
                                if (jsonMatch) { result = JSON.parse(jsonMatch[0]); } else { responseText = responseText.replace(/```json/g, '').replace(/```/g, '').trim(); result = JSON.parse(responseText); } 
                                if (result && (result.amount || result.amount === 0)) { 
                                    const cleanAmount = String(result.amount).replace(/[^0-9.]/g, ''); 
                                    const autoNote = (result.date ? result.date + " " : "") + (result.store || ""); 
                                    setPendingReceipts(prev => prev.map(p => p.id === item.id ? { ...p, amount: cleanAmount, note: autoNote, isAnalyzing: false } : p)); 
                                } else { throw new Error("Invalid JSON"); } 
                            } catch (error) { 
                                let errorMsg = 'è¾¨è­˜å¤±æ•—'; if (error.message.includes('NO_API_KEY')) { errorMsg = 'è«‹è¨­å®š API Key'; setQuotaStatus({ type: 'error', text: 'âŒ æœªè¨­å®š API é‡‘é‘°' }); setIsKeyModalOpen(true); } 
                                setPendingReceipts(prev => prev.map(p => p.id === item.id ? { ...p, note: errorMsg, isAnalyzing: false, isChecked: false } : p)); 
                            } finally { resolve(); } }; 
                        reader.readAsDataURL(item.file); 
                    }); 
                })); 
                setIsAnalyzingReceipt(false); 
                setQuotaStatus({ type: 'normal', text: 'åˆ†æå®Œæˆ' }); 
                inputElement.value = ''; 
            };
            const handleOpenDailyDetail = (dayStats) => { setSelectedDailyStats(dayStats); setIsDailyDetailOpen(true); };
            const handleOpenEmailClick = () => { const savedEmail = localStorage.getItem('user_email') || "yofarn@gmail.com"; setEmailInput(savedEmail); setIsEmailModalOpen(true); };
            const handleSendEmail = async () => {
                if (!emailInput) { alert("è«‹è¼¸å…¥ä¿¡ç®±"); return; } setIsSendingEmail(true); localStorage.setItem('user_email', emailInput);
                try {
                    let tableRows = ""; let grandTotal = 0;
                    tripData.forEach(day => {
                        tableRows += `<tr style="background-color: #e2e8f0;"><td colspan="4" style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: #333;">${day.date} - ${day.title}</td></tr>`;
                        day.spots.forEach(spot => {
                            const spotExpenses = expenses[spot.id] || [];
                            spotExpenses.forEach(record => { tableRows += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${day.date}</td><td style="border: 1px solid #ddd; padding: 8px;">${spot.name} (${record.category})</td><td style="border: 1px solid #ddd; padding: 8px;">${record.note || '-'}</td><td style="border: 1px solid #ddd; padding: 8px;">${record.amount}</td></tr>`; grandTotal += (record.amount || 0); });
                            if (spot.ticket) { const counts = getTicketCounts(spot.id); const ticketCost = (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child); if (ticketCost > 0) { tableRows += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${day.date}</td><td style="border: 1px solid #ddd; padding: 8px;">${spot.name} (é–€ç¥¨)</td><td style="border: 1px solid #ddd; padding: 8px;">å…¨ç¥¨${counts.adult}, å„ªå¾…${counts.child}</td><td style="border: 1px solid #ddd; padding: 8px;">${ticketCost}</td></tr>`; grandTotal += ticketCost; } }
                        });
                    });
                    const htmlMessage = `<h2 style="color: #333;">2025 è·¨å¹´è¦ªå­éŠ - èŠ±è²»æ˜ç´°</h2><table style="width:100%; border-collapse: collapse; font-family: sans-serif; border: 1px solid #ddd;"><thead><tr style="background-color: #4ECDC4; color: white;"><th style="border: 1px solid #ddd; padding: 12px;">æ—¥æœŸ</th><th style="border: 1px solid #ddd; padding: 12px;">åœ°é»/é …ç›®</th><th style="border: 1px solid #ddd; padding: 12px;">å‚™è¨»</th><th style="border: 1px solid #ddd; padding: 12px;">é‡‘é¡ (NT$)</th></tr></thead><tbody>${tableRows}</tbody><tfoot><tr style="background-color: #f8f9fa;"><td colspan="3" style="border: 1px solid #ddd; padding: 12px; text-align: right; font-weight: bold; color: #333;">ç¸½è¨ˆ</td><td style="border: 1px solid #ddd; padding: 12px; font-weight: bold; color: #E63946;">NT$ ${grandTotal.toLocaleString()}</td></tr></tfoot></table><p style="font-size: 12px; color: #666; margin-top: 20px;">æœ¬ä¿¡ä»¶ç”±æ—…éŠè¦åŠƒ App è‡ªå‹•ç™¼é€ã€‚</p>`;
                    const params = { email: emailInput, to_email: emailInput, recipient: emailInput, subject: `æ—…éŠèŠ±è²»å ±è¡¨_${new Date().toLocaleDateString()}`, message: htmlMessage };
                    await window.emailjs.send("service_5yh7x6g", "template_dlbyml8", params);
                    alert("âœ… ç™¼é€æˆåŠŸï¼"); setIsEmailModalOpen(false);
                } catch (error) { alert("âŒ ç™¼é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚"); } finally { setIsSendingEmail(false); }
            };
            const handleCalcPress = (val) => { if (val === 'AC') { setCalcInput(""); setCalcResult(""); } else if (val === 'DEL') { setCalcInput(prev => prev.slice(0, -1)); } else if (val === '=') { try { if (!calcInput) return; let expression = calcInput.replace(/\^/g, '**'); const result = new Function('return ' + expression)(); if (!isFinite(result) || isNaN(result)) { setCalcResult("Error"); } else { const formatted = Math.round(result * 100000000) / 100000000; setCalcResult(String(formatted)); } } catch (e) { setCalcResult("Error"); } } else { setCalcInput(prev => prev + val); } };
            const handlePhotoGps = () => {
                setPhotoSearchStatus({ text: 'GPS å®šä½ä¸­...', type: 'loading' });
                if (!navigator.geolocation) { setPhotoSearchStatus({ text: 'ä¸æ”¯æ´ GPS', type: 'error' }); return; }
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude; const lon = position.coords.longitude;
                    if (mapInstanceRef.current) { mapInstanceRef.current.setView([lat, lon], 15); if (markerInstanceRef.current) mapInstanceRef.current.removeLayer(markerInstanceRef.current); markerInstanceRef.current = L.marker([lat, lon]).addTo(mapInstanceRef.current); }
                    setPhotoSearchStatus({ text: 'è½‰æ›åœ°å€ä¸­...', type: 'loading' });
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14`).then(res => res.json()).then(data => { let place = data.address ? (data.address.city || data.address.town || data.address.district || "") : ""; if (place) { setPhotoSearchLocation(place); setPhotoSearchStatus({ text: `ğŸ“ å·²å®šä½ï¼š${place}`, type: 'success' }); } else { setPhotoSearchLocation("æˆ‘çš„ä½ç½®"); setPhotoSearchStatus({ text: 'ç„¡æ³•è¾¨è­˜åœ°å', type: 'error' }); } }).catch(err => setPhotoSearchStatus({ text: 'ç¶²è·¯éŒ¯èª¤', type: 'error' }));
                }, (err) => setPhotoSearchStatus({ text: 'å®šä½å¤±æ•—', type: 'error' }), { enableHighAccuracy: true, timeout: 20000 });
            };
            const executePhotoSearch = () => {
                let locationVal = photoSearchLocation.trim(); if (!locationVal) { setPhotoSearchStatus({ text: 'è«‹è¼¸å…¥åœ°é»ï¼', type: 'error' }); return; }
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationVal)}`).then(res => res.json()).then(data => { if (data && data.length > 0 && mapInstanceRef.current) { mapInstanceRef.current.setView([data[0].lat, data[0].lon], 13); if (markerInstanceRef.current) mapInstanceRef.current.removeLayer(markerInstanceRef.current); markerInstanceRef.current = L.marker([data[0].lat, data[0].lon]).addTo(mapInstanceRef.current); } });
                let finalQuery = locationVal; if (photoSearchPeople.length > 0) finalQuery += " " + photoSearchPeople.join(" ");
                const url = `https://photos.google.com/search/$${encodeURIComponent(finalQuery)}`;
                setPhotoSearchStatus({ text: 'æ­£åœ¨é–‹å•Ÿç›¸ç°¿...', type: 'success' }); setTimeout(() => { window.open(url, '_blank'); }, 500);
            };
            const togglePhotoPerson = (name) => { setPhotoSearchPeople(prev => prev.includes(name) ? prev.filter(p => p !== name) : [...prev, name]); };
            
            // Map init for StatsTab
            useEffect(() => {
                 if (activeTab === 'stats' && mapContainerRef.current) {
                    if (!mapInstanceRef.current) {
                        mapInstanceRef.current = L.map(mapContainerRef.current).setView([24.7671, 121.2177], 9);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM', maxZoom: 19 }).addTo(mapInstanceRef.current);
                    }
                    setTimeout(() => { mapInstanceRef.current.invalidateSize(); }, 100);
                }
            }, [activeTab]);

            // --- Handlers (B) ---
            const checkFlight = async () => { setAiLoading(true); setFlightAnalysis("ğŸ” AI é©—è­‰ä¸­..."); try { const prompt = `æª¢æŸ¥èˆªç­ï¼šå»ç¨‹ ${FLIGHT_INFO_B.outbound.flight} (${FLIGHT_INFO_B.outbound.date}) èˆ‡ å›ç¨‹ ${FLIGHT_INFO_B.inbound.flight} (${FLIGHT_INFO_B.inbound.date})ã€‚è«‹æŸ¥è©¢è¿‘æœŸæº–é»ç‡ã€èˆªå»ˆç•°å‹•èˆ‡æ³¨æ„äº‹é … (ç¹é«”ä¸­æ–‡)ã€‚`; const res = await generateGeminiContent(prompt, null, true); setFlightAnalysis(res); } catch(e) { setFlightAnalysis("èˆªç­è³‡è¨Šé©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯ã€‚"); if(e.message.includes("KEY")) setIsKeyModalOpen(true); } setAiLoading(false); };
            const checkHotel = async (hName) => { setAiLoading(true); setHotelAnalysis(p => ({...p, [hName]: "ğŸ” AI åˆ†æä¸­..."})); try { const prompt = `é£¯åº—é˜²é›·æª¢æŸ¥ï¼š${hName} (æ±äº¬åœ°å€)ã€‚è«‹æª¢æŸ¥ï¼š1. é™„è¿‘çš„è¶…å¸‚/ä¾¿åˆ©å•†åº—? 2. é£¯åº—é™„è¨­åœè»Šå ´æˆ–æ˜¯åˆç´„åœè»Šå ´è³‡è¨Š? 3. è¿‘æœŸæ˜¯å¦æœ‰åš´é‡è² è©•(å™ªéŸ³/æ¸…æ½”)? 4. é›¢è»Šç«™å¯¦éš›æ­¥è¡Œè·é›¢ã€‚è«‹ç°¡çŸ­å›è¦†ã€‚`; const res = await generateGeminiContent(prompt, null, true); setHotelAnalysis(p => ({...p, [hName]: res})); } catch(e) { setHotelAnalysis(p => ({...p, [hName]: "åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯ã€‚"})); if(e.message.includes("KEY")) setIsKeyModalOpen(true); } setAiLoading(false); };
            const checkSpot = async (spot, dateStr) => { setAiLoading(true); const fullTime = `2026å¹´${dateStr} ${spot.timeHint || ''}`.trim(); const key = spot.name + fullTime; setSpotAnalysis(p => ({...p, [key]: "ğŸ” æƒé›·ä¸­..."})); try { const prompt = `æ™¯é»æƒé›·ï¼š${spot.name}ã€‚é è¨ˆåˆ°è¨ªæ™‚é–“ï¼š${fullTime}ã€‚è«‹æª¢æŸ¥ï¼š1.è©²æ—¥æœŸæ™‚é–“æ˜¯å¦ç‡Ÿæ¥­/å…¬ä¼‘? 2.è¿‘æœŸæ˜¯å¦æœ‰æ•´ä¿®æˆ–é—œé–‰? 3.å»ºè­°åœç•™æ™‚é–“èˆ‡é¿é›·é‡(å¦‚æ’éšŠéé•·)ã€‚`; const res = await generateGeminiContent(prompt, null, true); setSpotAnalysis(p => ({...p, [key]: res})); } catch(e) { setSpotAnalysis(p => ({...p, [key]: "åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯ã€‚"})); if(e.message.includes("KEY")) setIsKeyModalOpen(true); } setAiLoading(false); };
            const analyzeGeneral = async () => { if(!aiInput) return; setAiLoading(true); setAiGeneralResult("ğŸ” AI åˆ†æä¸­..."); try { const res = await generateGeminiContent(`è«‹åˆ†æé€™æ®µæ—…éŠè³‡è¨Šçš„é¢¨éšªèˆ‡æ­£ç¢ºæ€§ï¼š${aiInput}`, null, true); setAiGeneralResult(res); } catch(e) { setAiGeneralResult("åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯ã€‚"); if(e.message.includes("KEY")) setIsKeyModalOpen(true); } setAiLoading(false); };

            
            // --- Render ---
            return (
                <div className="min-h-screen pb-24">
                    <nav className="sticky top-0 z-50 bg-[#0B1121]/80 backdrop-blur-md border-b border-slate-700 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-20">
                                <div className="flex items-center gap-3">
                                    <div className="bg-[#FF9F1C] p-2 rounded-2xl text-white shadow-lg -rotate-6 border border-white/20"><Icons.Plane size={24} strokeWidth={3} /></div>
                                    <div><div className="font-extrabold text-2xl tracking-tight text-slate-100 flex items-center gap-2 neon-text">2025 è·¨å¹´ <Icons.Smile className="text-[#FF9F1C]" size={20}/></div><div className="text-xs font-bold text-[#FFD700] tracking-widest uppercase bg-[#FFD700]/10 px-2 py-0.5 rounded-full inline-block border border-[#FFD700]/30">Family New Year Trip</div></div>
                                </div>
                                <div className="flex gap-2"><button onClick={() => setIsKeyModalOpen(true)} className="md:hidden bg-slate-800 p-2 rounded-full text-slate-400 border border-slate-700"><Icons.Settings size={20} /></button><div className="text-right hidden sm:block"><div className="text-[10px] font-bold text-slate-400 uppercase bg-slate-800 px-2 rounded-full border border-slate-700">Total</div><div className="font-mono font-bold text-[#FF6B6B] text-lg">NT$ {stats.totalJpy.toLocaleString()}</div></div></div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto p-4 md:p-8">
                        {activeTab === 'itinerary' && (
                            <ItineraryTab 
                                tripData={tripData} selectedDay={selectedDay} setSelectedDay={setSelectedDay} dayStartTimes={dayStartTimes} handleDayStartTimeChange={handleDayStartTimeChange} handleDepartureToggle={handleDepartureToggle} handleTransportToggle={handleTransportToggle} handleStayChangeNew={handleStayChangeNew} handleGetSpotTip={handleGetSpotTip} activeTipSpotId={activeTipSpotId} aiTips={aiTips} isTipLoading={isTipLoading} openExpenseModal={openExpenseModal} transportModes={transportModes} expenses={expenses} getTicketCounts={getTicketCounts} STAY_OPTIONS={STAY_OPTIONS}
                            />
                        )}

                        {activeTab === 'info' && (
                            <InfoTab 
                                userLocation={userLocation} isLocating={isLocating} handleGetLocation={handleGetLocation} infoRegion={infoRegion} setInfoRegion={setInfoRegion} aiSouvenirs={aiSouvenirs} isAiSouvenirLoading={isAiSouvenirLoading} aiNews={aiNews} isAiNewsLoading={isAiNewsLoading} 
                            />
                        )}

                        {activeTab === 'stats' && (
                            <StatsTab 
                                calcInput={calcInput} calcResult={calcResult} handleCalcPress={handleCalcPress} photoSearchLocation={photoSearchLocation} setPhotoSearchLocation={setPhotoSearchLocation} photoSearchPeople={photoSearchPeople} togglePhotoPerson={togglePhotoPerson} photoSearchStatus={photoSearchStatus} handlePhotoGps={handlePhotoGps} executePhotoSearch={executePhotoSearch} mapContainerRef={mapContainerRef} dailyStats={dailyStats} handleOpenDailyDetail={handleOpenDailyDetail} handleOpenEmailClick={handleOpenEmailClick} stats={stats} 
                            />
                        )}
                        
                        {activeTab === 'ai_guard' && (
                            <AiGuardTab
                                aiLoading={aiLoading} checkFlight={checkFlight} flightAnalysis={flightAnalysis} checkHotel={checkHotel} hotelAnalysis={hotelAnalysis} AI_GUARD_DATA={AI_GUARD_DATA_B} checkSpot={checkSpot} spotAnalysis={spotAnalysis} aiInput={aiInput} setAiInput={setAiInput} analyzeGeneral={analyzeGeneral} aiGeneralResult={aiGeneralResult} setIsKeyModalOpen={setIsKeyModalOpen}
                            />
                        )}
                    </main>

                    {/* åº•éƒ¨å°è¦½åˆ— (å››é é¢) */}
                    <div className="fixed bottom-0 w-full bg-[#0B1121]/95 backdrop-blur-md border-t border-slate-700 pb-safe z-40 flex justify-around py-3 text-xs font-bold text-slate-500">
                        <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center gap-1 ${activeTab === 'itinerary' ? 'text-[#FFCB77]' : 'hover:text-slate-300'}`}><Icons.List size={22} /> è¡Œç¨‹</button>
                        <button onClick={() => setActiveTab('info')} className={`flex flex-col items-center gap-1 ${activeTab === 'info' ? 'text-[#4ECDC4]' : 'hover:text-slate-300'}`}><Icons.LayoutGrid size={22} /> è³‡è¨Š</button>
                        <button onClick={() => setActiveTab('stats')} className={`flex flex-col items-center gap-1 ${activeTab === 'stats' ? 'text-[#FF6B6B]' : 'hover:text-slate-300'}`}><Icons.Calculator size={22} /> çµ±è¨ˆ</button>
                        <button onClick={() => setActiveTab('ai_guard')} className={`flex flex-col items-center gap-1 ${activeTab === 'ai_guard' ? 'text-blue-400' : 'hover:text-slate-300'}`}><Icons.Shield size={22} /> AI æƒé›·</button>
                    </div>

                    <div className="fixed bottom-24 right-4 flex flex-col gap-3 z-50">
                        <button onClick={handleOpenMap} className="bg-slate-800 text-slate-300 p-3 rounded-full shadow-[0_4px_10px_rgba(0,0,0,0.5)] border border-slate-600 hover:bg-slate-700 hover:text-white transition-all"><Icons.Map size={24} /></button>
                        <button onClick={() => setIsKeyModalOpen(true)} className="bg-slate-800 text-slate-300 p-3 rounded-full shadow-[0_4px_10px_rgba(0,0,0,0.5)] border border-slate-600 hover:bg-slate-700 hover:text-white transition-all"><Icons.Settings size={24} /></button>
                    </div>

                    <ApiKeyModal isOpen={isKeyModalOpen} onClose={() => setIsKeyModalOpen(false)} />
                    
                    <ExpenseModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} currentEditingSpot={currentEditingSpot} expenseForm={expenseForm} setExpenseForm={setExpenseForm} handleImageUpload={handleImageUpload} pendingReceipts={pendingReceipts} togglePendingReceipt={togglePendingReceipt} removePendingReceipt={removePendingReceipt} saveExpense={saveExpense} expenses={expenses} deleteExpense={deleteExpense} isAnalyzingReceipt={isAnalyzingReceipt} quotaStatus={quotaStatus} />
                    
                    <DailyDetailModal isOpen={isDailyDetailOpen} onClose={() => setIsDailyDetailOpen(false)} dayData={selectedDailyStats} allExpenses={expenses} spotTicketCounts={spotTicketCounts} />

                    <EmailModal isOpen={isEmailModalOpen} onClose={() => setIsEmailModalOpen(false)} emailInput={emailInput} setEmailInput={setEmailInput} handleSendEmail={handleSendEmail} isSendingEmail={isSendingEmail} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
